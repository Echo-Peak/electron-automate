<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css">
    <style media="screen">
    body,html{
      margin:0;
      padding:0;
    }
    body,html{
      margin:0;
      padding:0;
      overflow: hidden;
    }
    iframe{
      overflow: hidden;
      padding:0;
      margin:0;
    }
    .mock-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 2em;
      background: white;
      box-shadow: 1px 0px 4px;
    }
    .mock-frame .container {
      position: relative;
      width: 100%;
      display: flex;
      flex-direction: row;
    }
    .mock-frame .container .flex {
      flex: 10;
      order: 1;
    }
    .mock-frame .container .window-toggles {
      flex: 1;
      order: 2;
      position: absolute;
      right: 0;
      height: 2em;
    }
    .mock-frame .container .window-toggles ul {
      padding: 0;
      margin: 0;
      height: 2em;
    }
    .mock-frame .container .window-toggles ul li {
      height: inherit;
      list-style: none;
      cursor: pointer;
      line-height: 2em;
      display: inline-block;
    }
    .mock-frame .container .window-toggles ul li:nth-child(1) {
      transition: all .3s;
    }
    .mock-frame .container .window-toggles ul li:nth-child(1):hover {
      background: #4abcff;
    }
    .mock-frame .container .window-toggles ul li:nth-child(2) {
      transition: all .3s;
    }
    .mock-frame .container .window-toggles ul li:nth-child(2):hover {
      background: #4abcff;
    }
    .mock-frame .container .window-toggles ul li:nth-child(3) {
      transition: all .3s;
    }
    .mock-frame .container .window-toggles ul li:nth-child(3):hover {
      background: #ff2d2d;
    }
    .mock-frame .container .window-toggles ul li i {
      height: inherit;
      padding: 0px 15px;
    }


    </style>

  </head>
  <body>
    <div class="mock-frame">
      <div class="container">
        <div class="flex"></div>
        <div class="window-toggles">
          <ul>
            <li title="Minimize" onclick='sendEvent("minimize")'><i class="fa fa-minus"></i></li>
            <li title="Maximize" onclick='sendEvent("Maximize")'><i class="fa fa-clone"> </i></li>
            <li title="Close" onclick='sendEvent("close")'><i class="fa fa-close"></i></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="youtube-player"></div>
    <img id='picture-viewer'></img>
    <video id='video-player' src=''></video>
    <audio src="" id='audio-player'></audio>

    <script>
    // in browser testing vars
    var testSearch = `?ip:192.168.1.9&
    port=7200&
    path=C:\\WEB PROJECTS\\Gulp POWERED Apps\\github\\electron-automate\\built\\data`;


      window.Player = {};
      function getHashData(){
        let _search = window.location.search.length ? window.location.search : testSearch;
        return _search.substring(1).split('&')
        .reduce(function(start, item){
          let keyValue = item.split('=');
          start[keyValue[0]] = decodeURIComponent(keyValue[1]);
          return start;
        },{});

      }
      function closeWindow(){
        socket.emit('hide-browser-window');

      }
      let externalData = getHashData();
      let dataPath = ['audio' ,'pictures' ,'videos'].reduce(function(start ,item){
        start[item] = externalData.path  + '\\built\\data\\' + item;
        return start
      },{});
      let socket = io.connect(`http://${externalData.ip}:${externalData.port}/dynamic` ,{reconnect:true});

      let elms = function (){
        return ['youtube-player' ,'video-player' ,'audio-player' ,'picture-viewer'].reduce(function(start ,item){
            start[item.split('-')[0]] = document.getElementById(item);
            return start
          },{});
      }


    function loadAudio(src ,config){
      elms().audio.src = dataPath.audio +'\\' +src;
      elms().audio.onerror = function(){
        socket.emit('media-error',{event:'audio' ,value:0});
      }
      elms().audio.onended = function(){
        window.Player.audio.playing = false;
      }
      elms().audio.onloadeddata = function(){
        let elm = elms().audio;
        elm.volume = config.volume || 1;
        elm.currentTime = config.currentTime || 0;
        elm.muted = (typeof config.muted === 'boolean' && config.muted) || false;
        config.autoplay && elm.play();

        window.Player.audio  = {
          name:src ,
          config:config ,
          mute(bool){
            elm.muted  = bool;
          },
          seek(seekTo){
            elm.currentTime = seekTo;
          },
          togglePlayback(bool){
            bool ? elm.pause() : elm.play();
            window.Player.audio.playing = bool;
          },
          stop(){
            elm.pause();
            window.Player.audio.playing = false;
          },
          volume(volume){
            elms().audio.volume = volume;
          }
        };
        config.autoplay && (window.Player.audio.playing = true)
      }
    }
    function loadPicture(file){
      let elm = elms().picture;
       elm.width = window.innerWidth;
       elm.height = window.innerHeight;
       elm.src = dataPath.pictures +'\\'+ file;
       window.Player.picture = {
         name:file,
         load(filename){
           elm.src = dataPath.picture +'\\'+ filename;
         },
         stop(){
           elm.src = '';
           elm.style.display = 'none';
         },
         togglePlayback(bool){
           bool ? (elm.style.display = 'none') : (elm.style.display = 'block');
         }
       }
    }
    function stopEverything(){
      let _elms = elms();
      console.log('clearing');
       _elms.audio.pause && _elms.audio.pause();
      _elms && (_elms.audio.src ='');
      _elms.youtube.stopVideo && _elms.youtube.stopVideo();
      Player.YT && Player.YT.stopVideo();
      _elms.youtube.style.display = 'none';

      _elms.picture.src && (_elms.picture.src = '');
      _elms.picture.style.display && (_elms.picture.style.display = 'none');
      _elms.video.pause && _elms.video.pause();
      _elms.video.src && (_elms.video.src ='');
      _elms.video.style.display && (_elms.video.style.display = 'none');

    }
    function loadVideo(src ,config){
      elms().video.src = dataPath.videos +'\\' +src;
      elms().video.onerror = function(){
        socket.emit('media-error',{event:'video error'});
      }
      elms().video.onended = function(){
        window.Player.video.playing = false;
      }
      elms().video.onloadeddata = function(){
        let elm = elms().video;
        elm.volume = config.volume || 1;
        elm.currentTime = config.currentTime || 0;
        elm.muted = (typeof config.muted === 'boolean' && config.muted) || false;
        config.autoplay && elm.play();
        elm.controls = (typeof config.controls === 'boolean' && config.controls) || false;
        window.Player.video  = {
          name:src ,
          config:config ,
          mute(bool){
            elm.muted  = bool;
          },
          seek(seekTo){
            elm.currentTime = seekTo;
          },
          togglePlayback(bool){
            bool ? elm.pause() : elm.play();
            window.Player.video.playing = bool;
          },
          stop(){
            elm.pause();
            elm.style.display = 'none';
            window.Player.video.playing = false;
          },
          volume(volume){
            elms().video.volume = volume;
          }
        };
        config.autoplay && (window.Player.video.playing = true)

      }
    }
    socket.on('media-change' ,function(mediaType){
      console.log(mediaType)
      if(window.Player[mediaType.type] && window.Player[mediaType.type].playing){
        socket.emit('media-error' ,{event:'media is playing / shown' })

      }

       if(mediaType.override){
        socket.emit('media-error' ,{event:'overridding!' ,mediaType})
        stopEverything();
      }else if(window.Player[mediaType.type] && window.Player[mediaType.type].playing && !mediaType.override){
        console.log('nope')
        return
      }

      console.log('got');
      switch(mediaType.type){
        case 'youtube':loadYoutube(mediaType.src ,mediaType.config);break;
        case 'audio':loadAudio(mediaType.src ,mediaType.config);break;
        case 'picture':loadPicture(mediaType.src, mediaType.config);break;
        case 'video':loadVideo(mediaType.src, mediaType.config);break;
      }
    });

    socket.on('connect' ,function(){
      socket.emit('connected' ,Date.now());
    });

    socket.on('volume-change' ,function(volume){
      window.Player.YT && window.Player.YT._volume(volume);
      window.Player.audio && window.Player.audio.volume(volume);
      window.Player.video && window.Player.video.volume(volume);
    });

    socket.on('playback-toggle' ,(playing)=>{
        window.Player.YT && window.Player.YT.togglePlayback(playing);
        window.Player.audio && window.Player.audio.togglePlayback(playing);
        window.Player.video && window.Player.video.togglePlayback(playing);
    });
    socket.on('playback-stop',()=>{
      window.Player.YT && window.Player.YT._stop();
      window.Player.audio && window.Player.audio.stop();
      window.Player.video && window.Player.video.stop();
    });

    socket.on('seek',(seekTo)=>{
      window.Player.YT && window.Player.YT._seek(seekTo);
      window.Player.audio && window.Player.audio.seek(seekTo);
      window.Player.video && window.Player.video.seek(seekTo);
    });
    socket.on('audio-mute',(bool)=>{
      window.Player.YT && window.Player.YT._mute(bool);
      window.Player.audio && window.Player.audio.mute(bool);
      window.Player.video && window.Player.video.mute(bool);
    });

    let youtubePlayer = elms().youtube;
    let timeout = null;
    function loadYoutube(videoID , config){
      elms().youtube.style.display = 'block';

       let isItReady = false;
      let interval = null;
      clearTimeout(timeout);

          if(config.timeout){
            timeout = setTimeout(function(){

              Player.YT.stopVideo();

            },config.timeout);
          }

      interval = setInterval(function(){
        if(isItReady){
            elms().youtube.height = window.innerHeight;
            elms().youtube.width = window.innerWidth;
            Player.YT.loadVideoById(videoID);

          clearInterval(interval);
        }
      },100);

      if(window.Player.YT){
        elms().youtube.height = window.innerHeight;
        elms().youtube.width = window.innerWidth;
        window.Player.YT.loadVideoById(videoID)
        return
      }
      console.log(Player ,videoID )
      window.Player.YT = new YT.Player(elms().youtube.id, {
                height: window.innerHeight,
                width: window.innerWidth,
                playerVars:{
                  autoplay:config.autoplay ? 1 : 0,
                  controls:config.controls ? 1 : 0,
                  rel:config.rel ? 1 : 0,
                  showinfo:config.show_info ? 1 : 0,
                  iv_load_policy:config.load_policy || 3
                },
                events: {
                  onReady: onPlayerReady,
                  onError:function(code){
                    socket.emit('media-error' ,{event:'youtube-error' ,value:code});
                  },
                  onStateChange: onPlayerStateChange
                }});


      config.autoplay && (window.Player.YT.playing = true)
      window.Player.YT._stop = function(){
        Player.YT.stopVideo();
        isItReady = false;
        elms().youtube.style.display ='none';
        window.Player.YT.playing = false;
      }
      window.Player.YT._seek = function(seekTo){
        Player.YT.seekTo(seekTo)
      }
      window.Player.YT.togglePlayback = function(bool){
        bool ? Player.YT.pauseVideo() : Player.YT.playVideo();
        window.Player.YT.playing = bool;
      }
      window.Player.YT._volume = function(volume){
         Player.YT.setVolume(volume * 100)
      }
      window.Player.YT._mute = function(bool){
         bool ? Player.YT.mute() : Player.YT.unMute();
      }
      let done = false;
      function onPlayerReady(event) {

        isItReady = true;

        //event.target.playVideo();
      }
      function onPlayerStateChange(event) {

        if (event.data == YT.PlayerState.PLAYING && !done) {
          config.mute && Player.YT.mute();
          config.autoplay && Player.YT.playVideo();
          Player.YT.setVolume(config.volume *100);
          done = true;

        }
       }

    }
    window.addEventListener('resize' ,function(){
      elms().youtube.height = window.innerHeight;
      elms().youtube.width = window.innerWidth;
    });

    let electron = require('electron');
    let {ipcRenderer} = electron.remote;
    function sendEvent(event){
      ipcRenderer.send(event);
    }
    </script>

  </body>
</html>
